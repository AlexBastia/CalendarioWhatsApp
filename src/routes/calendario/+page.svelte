<script>
  import Btn from '$lib/components/btn.svelte';
  import { goto } from '$app/navigation';
  import { timingStore } from '$lib/stores/timing.js';
  import SelectionModal from '$lib/components/SelectionModal.svelte';
  import { 
    format, getMonth, getYear, startOfMonth, endOfMonth, 
    addDays, addMonths, subMonths, subDays, startOfWeek, 
    eachDayOfInterval, endOfWeek, isSameMonth, isSameDay, 
    isToday } from 'date-fns';
  import "bootstrap/dist/css/bootstrap.min.css";

  let week = ['dom','lun', 'mar', 'mer', 'gio', 'ven', 'sab'];
  let {data} = $props();
  
  let currentDate = $derived($timingStore);
  let viewMode = $state('monthly'); 

  function toggleView() {
    viewMode = viewMode === 'daily' ? 'weekly' 
        : viewMode === 'weekly' ? 'monthly' 
        : 'daily';
  }

  function goBack() {
    currentDate = viewMode === 'daily' ? subDays(currentDate, 1) 
        : viewMode === 'weekly' ? subDays(currentDate, 7) 
        : subMonths(currentDate, 1);
  }

  function goAhead() {
    currentDate = viewMode === 'daily' ? addDays(currentDate, 1) 
        : viewMode === 'weekly' ? addDays(currentDate, 7) 
        : addMonths(currentDate, 1);
  }

  function getWeekDays(date) {
    let sunday = startOfWeek(date);
    let saturday = addDays(sunday, 6);
    return eachDayOfInterval({start: sunday, end: saturday});
  }

  function getMonthCalendarDays(date) {
    const monthStart = startOfMonth(date);
    const monthEnd = endOfMonth(date);
    const calendarStart = startOfWeek(monthStart);
    const calendarEnd = endOfWeek(monthEnd);
    return eachDayOfInterval({ start: calendarStart, end: calendarEnd });
  }

  let weekDays = $derived(getWeekDays(currentDate));
  let monthCalendarDays = $derived(getMonthCalendarDays(currentDate));
</script>

<div class="d-flex align-items-center gap-2 mb-4">
  <label for="view-mode" class="form-label">Vista:</label>
  <select id="view-mode" class="form-select w-auto" bind:value={viewMode}>
    <option value="daily">Giornaliera</option>
    <option value="weekly">Settimanale</option>
    <option value="monthly">Mensile</option>
  </select>
</div>

{#if viewMode === 'daily'}
  <div class="card">
    <div class="card-header fs-4 {isToday(currentDate) ? 'today' : ''}">
        {format(currentDate, 'dd MMMM yyyy, EEEE')}
    </div>
    <div class="list-group list-group-flush">
        {#each data.events as event}
            {#if isSameDay(event.start, currentDate)}
                <div classa="list-group-item">üìÖ {event.title}</div>
            {/if}
        {/each}
        {#each data.tasks as task}
            {#if isSameDay(task.deadline, currentDate) && task.status !== 'late'}
                <div classa="list-group-item {task.status === 'late' ? 'task-late' : ''}">üìù {task.title}</div>
            {/if}
        {/each}
        {#if isToday(currentDate)}
            {#each data.tasks as task}
                {#if task.status === 'late'}
                    <div classa="list-group-item task-late">üö® {task.title} (Scaduta)</div>
                {/if}
            {/each}
        {/if}
    </div>
  </div>

{:else if viewMode === 'weekly'}
  <div class="container-fluid">
    <div class="row text-center fw-bold border-bottom pb-2 mb-2">
      {#each week as day}
        <div class="col">{day}</div>
      {/each}
    </div>
    <div class="row">
      {#each weekDays as day}
        <div class="col border p-2 {isToday(day) ? 'today' : ''}" style="min-height: 120px;">
          <p class="text-center">{format(day, 'd')}</p>
          {#each data.events as event}
            {#if isSameDay(event.start, day)}
              <div class="badge bg-primary w-100 mb-1">üìÖ {event.title}</div>
            {/if}
          {/each}
          {#each data.tasks as task}
            {#if isSameDay(task.deadline, day)}
              <div class="badge w-100 mb-1 {task.status === 'late' ? 'bg-danger' : 'bg-success'}">üìù {task.title}</div>
            {/if}
          {/each}
        </div>
      {/each}
    </div>
  </div>

{:else}
  <div class="container-fluid">
    <div class="row text-center fw-bold border-bottom pb-2 mb-2">
      {#each week as day}
        <div class="col">{day}</div>
      {/each}
    </div>
    {#each Array(Math.ceil(monthCalendarDays.length / 7)) as _, weekIndex}
      <div class="row">
        {#each monthCalendarDays.slice(weekIndex * 7, (weekIndex + 1) * 7) as day}
          <div class="col border p-2 {isToday(day) ? 'today' : ''} {!isSameMonth(day, currentDate) ? 'text-muted bg-light' : ''}" style="min-height: 120px;">
            <p>{format(day, 'd')}</p>
            {#if isSameMonth(day, currentDate)}
              {#each data.events as event}
                {#if isSameDay(event.start, day)}
                  <div class="badge bg-primary w-100 mb-1">üìÖ {event.title}</div>
                {/if}
              {/each}
              {#each data.tasks as task}
                {#if isSameDay(task.deadline, day)}
                  <div class="badge w-100 mb-1 {task.status === 'late' ? 'bg-danger' : 'bg-success'}">üìù {task.title}</div>
                {/if}
              {/each}
            {/if}
          </div>
        {/each}
      </div>
    {/each}
  </div>
{/if}

<SelectionModal
    titleModal="Seleziona cosa vuoi aggiungere"
    idModal="eventTypeModal"
>
    <button
        type="button"
        class="btn btn-primary me-2"
        data-bs-dismiss="modal"
        onclick={() => goto('/calendario/addEvent')}
    >
        <i class="bi bi-calendar-plus"></i> Evento
    </button>
    <button
        type="button"
        class="btn btn-success"
        data-bs-dismiss="modal"
        onclick={
          
          () => {
            console.log('siva')  
            goto('/calendario/addTask')
          }
        }
    >
        <i class="bi bi-list-task"></i> Attivit√†
    </button>
</SelectionModal>
<Btn modalTarget="#eventTypeModal" ariaLabel="Aggiungi evento o attivit√†" >
</Btn>


<div class="mt-4 d-flex justify-content-between">
    <div>
        <button class="btn btn-outline-primary" onclick={goBack}>
            Indietro
        </button>
        <button class="btn btn-outline-primary" onclick={goAhead}>
            Avanti
        </button>
    </div>
    
</div>

<style>
    .today {
        background-color: #e0f7fa; /* Un colore celeste per evidenziare oggi */
    }
    .task-late {
        background-color: #ffebee; /* Un colore rosato per le attivit√† in ritardo nella vista giornaliera */
        color: #c62828;
        border-color: #c62828 !important;
    }
    .badge {
        white-space: normal;
        text-align: left;
    }
</style>
